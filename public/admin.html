<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Panaderia Navide√±a</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .navbar {
            background: #c41e3a;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand { font-size: 1.3rem; font-weight: 700; }
        .navbar-links { display: flex; gap: 20px; align-items: center; }
        .navbar-links a { color: white; text-decoration: none; }
        .logout-btn {
            background: white;
            color: #c41e3a;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #c41e3a;
            color: white;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h4 { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: #333; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-card h4 { margin-bottom: 15px; color: #333; }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table th { background: #f5f5f5; font-weight: 600; }
        .data-table tr:hover { background: #fafafa; }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .btn-primary { background: #c41e3a; color: white; }
        .btn-secondary { background: #666; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-danger { background: #d32f2f; color: white; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .alert { padding: 12px; border-radius: 6px; margin-bottom: 15px; }
        .alert-error { background: #ffebee; color: #c62828; }
        .alert-success { background: #e8f5e9; color: #2e7d32; }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters input, .filters select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .stock-warning { color: #d32f2f; font-weight: 600; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .data-table { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <span class="navbar-brand">üéÑ Panel de Administracion</span>
        <div class="navbar-links">
            <a href="index.html">Tienda</a>
            <span id="adminName">Admin</span>
            <button class="logout-btn" onclick="logout()">Salir</button>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('productos')">Productos</button>
            <button class="tab-btn" onclick="showTab('usuarios')">Usuarios</button>
            <button class="tab-btn" onclick="showTab('ventas')">Ventas</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Ventas</h4>
                    <div class="value" id="statTotalVentas">0</div>
                </div>
                <div class="stat-card">
                    <h4>Ingresos Totales</h4>
                    <div class="value" id="statIngresos">$0</div>
                </div>
                <div class="stat-card">
                    <h4>Usuarios Activos</h4>
                    <div class="value" id="statUsuarios">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>Ventas por Dia (ultimos 30 dias)</h4>
                    <canvas id="ventasDiaChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Ventas por Categoria</h4>
                    <canvas id="categoriasChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4>Productos Mas Vendidos</h4>
                    <canvas id="productosChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Mejores Clientes</h4>
                    <canvas id="clientesChart"></canvas>
                </div>
            </div>

            <div class="section">
                <h3>‚ö†Ô∏è Productos con Poco Stock</h3>
                <table class="data-table" id="stockWarningTable">
                    <thead><tr><th>Producto</th><th>Stock</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="productos" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; border: none; padding: 0;">Inventario de Productos</h3>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Producto</button>
                </div>
                <div id="productAlert"></div>
                <table class="data-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Categoria</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="usuarios" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; border: none; padding: 0;">Gestion de Usuarios</h3>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Nuevo Usuario</button>
                </div>
                <div id="userAlert"></div>
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Fondos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="ventas" class="tab-content">
            <div class="section">
                <h3>Historial de Ventas</h3>
                <div class="filters">
                    <input type="date" id="fechaInicio" placeholder="Fecha inicio">
                    <input type="date" id="fechaFin" placeholder="Fecha fin">
                    <button class="btn btn-primary" onclick="filterSales()">Filtrar</button>
                    <button class="btn btn-secondary" onclick="loadSales()">Ver Todas</button>
                </div>
                <table class="data-table" id="salesTable">
                    <thead>
                        <tr>
                            <th>No. Venta</th>
                            <th>Usuario</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Nuevo Producto</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="productName" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" id="productPrice" required min="0.01" max="99999999.99" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripcion</label>
                    <textarea id="productDesc" rows="3" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" id="productStock" required min="0" max="99999">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="productCategory" required></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>URL Imagen</label>
                    <input type="url" id="productImage">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="productSpecial"> Producto Especial/Temporada</label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Guardar</button>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Nuevo Usuario</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userName" required minlength="3" maxlength="50" pattern="[a-zA-Z0-9_]+">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a <span id="passwordHint">(requerida)</span></label>
                    <input type="password" id="userPassword" minlength="6" maxlength="100">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="userRole">
                            <option value="cliente">Cliente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fondos Iniciales</label>
                        <input type="number" id="userFunds" value="0" min="0" max="999999999999" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Sale Detail Modal -->
    <div class="modal" id="saleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalle de Venta</h3>
                <button class="modal-close" onclick="closeModal('saleModal')">&times;</button>
            </div>
            <div id="saleDetail"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3001' : '';
        let categories = [];

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
        });

        async function checkAdminAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/verificar`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!response.ok || data.user.rol !== 'admin') {
                    alert('Acceso denegado. Solo administradores.');
                    window.location.href = 'auth.html';
                    return;
                }

                document.getElementById('adminName').textContent = data.user.username;
                loadDashboard();
                loadCategories();
            } catch (err) {
                window.location.href = 'auth.html';
            }
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'productos') loadProducts();
            else if (tabId === 'usuarios') loadUsers();
            else if (tabId === 'ventas') loadSales();
            else if (tabId === 'dashboard') loadDashboard();
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/api/admin/estadisticas`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                const stats = await response.json();

                document.getElementById('statTotalVentas').textContent = stats.resumen.total_ventas;
                document.getElementById('statIngresos').textContent = `$${stats.resumen.monto_total.toLocaleString('es-MX')}`;
                document.getElementById('statUsuarios').textContent = stats.resumen.total_usuarios;

                // Ventas por d√≠a chart
                const ventasCtx = document.getElementById('ventasDiaChart').getContext('2d');
                new Chart(ventasCtx, {
                    type: 'line',
                    data: {
                        labels: stats.ventas_por_dia.map(v => v.fecha).reverse(),
                        datasets: [{
                            label: 'Ingresos',
                            data: stats.ventas_por_dia.map(v => v.monto).reverse(),
                            borderColor: '#c41e3a',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true }
                });

                // Categor√≠as chart
                const catCtx = document.getElementById('categoriasChart').getContext('2d');
                new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: stats.ventas_por_categoria.map(c => c.categoria),
                        datasets: [{
                            data: stats.ventas_por_categoria.map(c => c.ingresos),
                            backgroundColor: ['#c41e3a', '#2e7d32', '#1565c0', '#f57c00', '#7b1fa2']
                        }]
                    },
                    options: { responsive: true }
                });

                // Productos m√°s vendidos
                const prodCtx = document.getElementById('productosChart').getContext('2d');
                new Chart(prodCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.productos_mas_vendidos.map(p => p.nombre),
                        datasets: [{
                            label: 'Cantidad vendida',
                            data: stats.productos_mas_vendidos.map(p => p.cantidad),
                            backgroundColor: '#c41e3a'
                        }]
                    },
                    options: { responsive: true, indexAxis: 'y' }
                });

                // Mejores clientes
                const clientCtx = document.getElementById('clientesChart').getContext('2d');
                new Chart(clientCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.mejores_clientes.map(c => c.username),
                        datasets: [{
                            label: 'Total gastado',
                            data: stats.mejores_clientes.map(c => c.gastado),
                            backgroundColor: '#2e7d32'
                        }]
                    },
                    options: { responsive: true }
                });

                // Stock warning table
                const tbody = document.querySelector('#stockWarningTable tbody');
                tbody.innerHTML = stats.productos_poco_stock.map(p => `
                    <tr>
                        <td>${p.nombre}</td>
                        <td class="stock-warning">${p.stock}</td>
                    </tr>
                `).join('') || '<tr><td colspan="2">No hay productos con poco stock</td></tr>';

            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/categorias`);
                categories = await response.json();

                const select = document.getElementById('productCategory');
                select.innerHTML = categories.map(c =>
                    `<option value="${c.id_categoria}">${c.nombre}</option>`
                ).join('');
            } catch (err) {
                console.error('Error loading categories:', err);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/api/productos`);
                const products = await response.json();

                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = products.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.price}</td>
                        <td class="${p.stock < 10 ? 'stock-warning' : ''}">${p.stock}</td>
                        <td>${p.categoria}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editProduct(${p.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }

        function openProductModal(product = null) {
            document.getElementById('productModalTitle').textContent = product ? 'Editar Producto' : 'Nuevo Producto';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = product ? product.id : '';

            if (product) {
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.precio;
                document.getElementById('productDesc').value = product.desc;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCategory').value = product.id_categoria;
                document.getElementById('productImage').value = product.image;
                document.getElementById('productSpecial').checked = product.es_especial;
            }

            document.getElementById('productModal').classList.add('active');
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`${API_URL}/api/productos/${id}`);
                const product = await response.json();
                openProductModal(product);
            } catch (err) {
                alert('Error al cargar producto');
            }
        }

        async function saveProduct(event) {
            event.preventDefault();

            const id = document.getElementById('productId').value;
            const data = {
                nombre: document.getElementById('productName').value,
                precio: parseFloat(document.getElementById('productPrice').value),
                descripcion: document.getElementById('productDesc').value,
                stock: parseInt(document.getElementById('productStock').value),
                id_categoria: parseInt(document.getElementById('productCategory').value),
                imagen_url: document.getElementById('productImage').value,
                es_especial: document.getElementById('productSpecial').checked
            };

            try {
                const response = await fetch(`${API_URL}/api/productos${id ? '/' + id : ''}`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                closeModal('productModal');
                loadProducts();
                showAlert('productAlert', 'Producto guardado exitosamente', 'success');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('¬øEliminar este producto?')) return;

            try {
                const response = await fetch(`${API_URL}/api/productos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Error al eliminar');

                loadProducts();
                showAlert('productAlert', 'Producto eliminado', 'success');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/api/usuarios`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const users = await response.json();

                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id_usuario}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.rol}</td>
                        <td>$${parseFloat(u.fondos).toLocaleString('es-MX')}</td>
                        <td>${u.activo ? 'Activo' : 'Inactivo'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editUser(${u.id_usuario})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteUser(${u.id_usuario})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        function openUserModal(user = null) {
            document.getElementById('userModalTitle').textContent = user ? 'Editar Usuario' : 'Nuevo Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = user ? user.id_usuario : '';
            document.getElementById('passwordHint').textContent = user ? '(dejar vacio para no cambiar)' : '(requerida)';
            document.getElementById('userPassword').required = !user;

            if (user) {
                document.getElementById('userName').value = user.username;
                document.getElementById('userName').disabled = true;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.rol;
                document.getElementById('userFunds').value = user.fondos;
            } else {
                document.getElementById('userName').disabled = false;
            }

            document.getElementById('userModal').classList.add('active');
        }

        async function editUser(id) {
            try {
                const response = await fetch(`${API_URL}/api/usuarios/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const user = await response.json();
                openUserModal(user);
            } catch (err) {
                alert('Error al cargar usuario');
            }
        }

        async function saveUser(event) {
            event.preventDefault();

            const id = document.getElementById('userId').value;
            const data = {
                email: document.getElementById('userEmail').value,
                rol: document.getElementById('userRole').value
            };

            if (!id) {
                data.username = document.getElementById('userName').value;
                data.password = document.getElementById('userPassword').value;
                data.fondos = parseFloat(document.getElementById('userFunds').value);
            } else {
                const password = document.getElementById('userPassword').value;
                if (password) data.password = password;
            }

            try {
                const response = await fetch(`${API_URL}/api/usuarios${id ? '/' + id : ''}`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                closeModal('userModal');
                loadUsers();
                showAlert('userAlert', 'Usuario guardado exitosamente', 'success');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteUser(id) {
            if (!confirm('¬øEliminar este usuario?')) return;

            try {
                const response = await fetch(`${API_URL}/api/usuarios/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                loadUsers();
                showAlert('userAlert', 'Usuario eliminado', 'success');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadSales() {
            try {
                const response = await fetch(`${API_URL}/api/admin/ventas`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const sales = await response.json();
                renderSales(sales);
            } catch (err) {
                console.error('Error loading sales:', err);
            }
        }

        async function filterSales() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            let url = `${API_URL}/api/admin/ventas?`;
            if (inicio) url += `fecha_inicio=${inicio}&`;
            if (fin) url += `fecha_fin=${fin}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const sales = await response.json();
                renderSales(sales);
            } catch (err) {
                console.error('Error filtering sales:', err);
            }
        }

        function renderSales(sales) {
            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = sales.map(s => `
                <tr>
                    <td>${s.numero_venta}</td>
                    <td>${s.username}</td>
                    <td>${new Date(s.fecha_compra).toLocaleString('es-MX')}</td>
                    <td>$${s.total.toFixed(2)}</td>
                    <td>${s.estado}</td>
                    <td>
                        <button class="btn btn-secondary" onclick='viewSale(${JSON.stringify(s)})'>Ver</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6">No hay ventas</td></tr>';
        }

        function viewSale(sale) {
            let html = `
                <p><strong>No. Venta:</strong> ${sale.numero_venta}</p>
                <p><strong>Usuario:</strong> ${sale.username}</p>
                <p><strong>Fecha:</strong> ${new Date(sale.fecha_compra).toLocaleString('es-MX')}</p>
                <hr>
                <h4>Productos:</h4>
            `;

            sale.productos.forEach(p => {
                html += `<p>${p.nombre_producto} x${p.cantidad} - $${parseFloat(p.subtotal).toFixed(2)}</p>`;
            });

            html += `
                <hr>
                <p><strong>Subtotal:</strong> $${sale.subtotal.toFixed(2)}</p>
                <p><strong>Envio:</strong> $${sale.costo_envio.toFixed(2)}</p>
                <p><strong>Total:</strong> $${sale.total.toFixed(2)}</p>
            `;

            document.getElementById('saleDetail').innerHTML = html;
            document.getElementById('saleModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'auth.html';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
